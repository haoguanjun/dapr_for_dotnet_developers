# 第 5 章 Dapr 参考应用

在本书的开始，你已经学习了关于 Dapr 的基本优势。你看到了 Dapr 是如何帮助你的团队在降低架构和操作复杂性的同时构建分布式应用程序。沿着这个方向，你已经可以构建一些小型的 Dapr 应用。现在，是时候探索一个端到端的微服务应用程序了，它演示了 Dapr 的构建块和组件。

但是，首先简单回顾一下历史。

## eShop on containers

许多年前，Microsoft，与领先的社区专家合作，发布了一本广受欢迎的指导书，名为：.NET Microservice for Containerized .NET Application。如图 3-1 所示。



该书深入介绍了用于构建分布式应用程序的特性、模式，以及最佳实践。它包括一个全功能的微服务参考应用，展示了架构概念，名为：eShopOnContainers，该应用展示了一个销售多种 .NET 物品的电子商店，包括衣服和咖啡。使用 .NET Core 构建，是跨平台，既可以运行在 Linux 又可以运行在 Windows 的容器中。图 3-2 展示了原始的 eShop 架构。



如你所见，eShopOnContainers 包括许多部分

1. 3 种不同的客户端
2. 一个应用程序网关，为前端抽象了后端
3. 多个后端的核心微服务
4. 一个事件总线组件，支持异步的发布/订阅消息

eShopOnContainers 参考应用被 .NET 社区广泛接受，并用于建模许多大型的商业微服务应用程序。

## eShop on Dapr

在本书种，另一个版本的 eShop 应用程序被实现出来。它被称为 eShopOnDapr。该升级版本通过集成 Dapr 构建块和组件对早期的 eShopOnContainer 应用程序进行了演进。图 3-3 展示了新的精简方案的架构。



重点在于 eShopOnDapr 参考应用使用 Dapr 构建。原来的应用程序被升级了。架构包括：

1. 使用流行的 Angular SPA 框架开发的单页应用。它将用户的请求发送给 API 网关微服务。

2. API 网关抽象了后端核心微服务。使用 Envoy 实现。这是一个高性能、开源的服务网关。Envoy 将入站请求路由到后端微服务。大多数的请求是简单的 CRUD 操作 (例如：从目录种获取品牌的列表) ，然后直接调用后端微服务处理。

3. 其它请求逻辑上更为复杂，需要多个微服务一起处理。对于这些场景，eShopOnDapr 实现了一个聚合微服务，它跨越多个涉及完成操作的微服务编排为工作流进行处理。

4. 后端的核心微服务集包括对于电子商务站点需要的功能。每个微服务都是自容器化，且独立于其它的微服务。遵循被广泛接纳的领域解构模式，每个微服务独立处理一种业务功能。

   * 购物车服务，管理客户的购物车体验
   * 目录服务，管理在售商品的项目
   * 身份服务，管理验证和身份
   * 订单服务，处理支付和管理订单的所有方便
   * 付款服务，处理客户端付款

   每种服务有自己的持久化策略。遵循微服务的最佳实践。这里没有一个共享的所有服务可以操作的数据库。

   每个微服务基于其自身的独立需求而设计。最简单的微服务使用基本的 CRUD 可操作来访问其底层的数据存储。高级的服务，例如订单服务，使用领域驱动设计方式来管理业务复杂性。如果需要的话，服务可以使用不同的技术栈来实现，例如 .NET Core、Java、Go、NodeJS 等等

5. 最后，事件总线封装了 Dapr 的发布/订阅组件。支持跨微服务的异步消息发布/订阅。开发者可以接入任何 Dapr 支持的消息中间件。

## Dapr 的应用构建块

eShopOnDapr 的代码比 eShopOnContainer 更加精简，Dapr 构建块大量的错误处理代码。

图 3-4 展示了在 eShop 参考应用种的 Dapr 集成



在上图种，你可以看到那个服务使用了那个 Dapr 构建块

1. 



## 应用 Dapr 到 eShop 的优势



## 总结

